# GitHub Actions workflow for slack.rs
# Auto-generated by add-runner.sh

name: Build and Push to Harbor - slack.rs

on:
  push:
    branches: [ master,main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: slack.rs-runners  # Custom Runner Scale Set
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: kubectl インストール
      run: |
        echo "=== kubectl インストール ==="
        
        # kubectl の最新版をインストール
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # インストール確認
        kubectl version --client --output=yaml
        
        echo "✅ kubectl インストール完了"
        
    - name: Harbor認証情報取得
      run: |
        echo "=== Harbor認証情報取得 ==="
        
        # kubectl in-cluster設定
        export KUBECONFIG=/tmp/kubeconfig
        kubectl config set-cluster default \
            --server=https://kubernetes.default.svc \
            --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            --kubeconfig=$KUBECONFIG
        kubectl config set-credentials default \
            --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) \
            --kubeconfig=$KUBECONFIG
        kubectl config set-context default \
            --cluster=default --user=default \
            --kubeconfig=$KUBECONFIG
        kubectl config use-context default --kubeconfig=$KUBECONFIG
        
        # Harbor認証情報取得
        kubectl get secret harbor-auth -n arc-systems -o yaml | grep "HARBOR_USERNAME:" | awk '{print $2}' | base64 -d > /tmp/harbor_username
        kubectl get secret harbor-auth -n arc-systems -o yaml | grep "HARBOR_PASSWORD:" | awk '{print $2}' | base64 -d > /tmp/harbor_password
        kubectl get secret harbor-auth -n arc-systems -o yaml | grep "HARBOR_URL:" | awk '{print $2}' | base64 -d > /tmp/harbor_url
        kubectl get secret harbor-auth -n arc-systems -o yaml | grep "HARBOR_PROJECT:" | awk '{print $2}' | base64 -d > /tmp/harbor_project
        
        chmod 600 /tmp/harbor_*
        echo "✅ Harbor認証情報取得完了"
        
    - name: Harbor Login & Docker設定
      run: |
        echo "=== Harbor Login & Docker設定 ==="
        
        HARBOR_USERNAME=$(cat /tmp/harbor_username)
        HARBOR_PASSWORD=$(cat /tmp/harbor_password)
        HARBOR_URL=$(cat /tmp/harbor_url)
        
        # /etc/hosts に Harbor エントリー追加
        echo "Harbor DNS設定を追加中..."
        echo "$HARBOR_URL harbor.local" | sudo tee -a /etc/hosts
        
        # Docker設定（DinD環境対応）
        echo "Docker設定を更新中..."
        
        # Docker daemon設定を更新（DinD環境）
        sudo mkdir -p /etc/docker
        echo "{\"insecure-registries\": [\"$HARBOR_URL\"], \"registry-mirrors\": []}" | sudo tee /etc/docker/daemon.json > /dev/null
        
        # 既存のDocker daemonを完全に停止
        sudo pkill -f dockerd || true
        sudo pkill -f docker-containerd || true
        sudo pkill -f containerd || true
        sleep 10
        
        # Docker daemonをinsecure registryで起動（強制的にHTTP接続）
        echo "Docker daemonを起動中..."
        sudo dockerd \
            --config-file=/etc/docker/daemon.json \
            --insecure-registry=$HARBOR_URL \
            --host=unix:///var/run/docker.sock \
            --host=tcp://0.0.0.0:2375 \
            --tls=false \
            --disable-legacy-registry=false \
            --log-level=info &
        sleep 30
        
        # Docker daemon起動確認
        docker version || (echo "Docker daemon起動失敗" && exit 1)
        
        # Docker daemon設定確認
        echo "=== Docker daemon設定ファイル ==="
        cat /etc/docker/daemon.json
        
        # Docker info詳細確認
        echo "=== Docker info（insecure registries） ==="
        docker info | grep -A 10 -B 5 -i insecure || echo "Insecure registry設定なし"
        
        # insecure registryが正しく設定されているか確認
        if docker info | grep -q "$HARBOR_URL"; then
            echo "✅ insecure registry設定が正しく適用されています"
        else
            echo "❌ insecure registry設定が適用されていません"
            echo "Docker daemon を再起動します..."
            sudo pkill -f dockerd || true
            sleep 5
            sudo dockerd --insecure-registry=$HARBOR_URL --host=unix:///var/run/docker.sock --tls=false &
            sleep 15
            docker info | grep -A 10 -B 5 -i insecure || echo "再起動後もinsecure registry設定なし"
        fi
        
        # Docker認証設定ファイル作成
        mkdir -p ~/.docker
        echo "{\"auths\":{\"$HARBOR_URL\":{\"auth\":\"$(echo -n \"$HARBOR_USERNAME:$HARBOR_PASSWORD\" | base64 -w 0)\"}},\"credHelpers\":{}}" > ~/.docker/config.json
        chmod 600 ~/.docker/config.json
        
        # Docker環境変数でinsecure registryを指定（DinD環境対応）
        export DOCKER_CONTENT_TRUST=0
        
        echo "✅ Harbor Login & Docker設定完了"
        
    - name: Docker Build
      run: |
        echo "=== Docker Build ==="
        
        HARBOR_URL=$(cat /tmp/harbor_url)
        HARBOR_PROJECT=$(cat /tmp/harbor_project)
        
        # Dockerイメージビルド（通常のタグ形式）
        docker build -t $HARBOR_URL/$HARBOR_PROJECT/slack.rs:latest .
        docker build -t $HARBOR_URL/$HARBOR_PROJECT/slack.rs:${{ github.sha }} .
        
        echo "✅ Docker Build完了"
        
    - name: Harbor Push
      run: |
        echo "=== Harbor Push ==="
        
        HARBOR_URL=$(cat /tmp/harbor_url)
        HARBOR_PROJECT=$(cat /tmp/harbor_project)
        HARBOR_USERNAME=$(cat /tmp/harbor_username)
        HARBOR_PASSWORD=$(cat /tmp/harbor_password)
        
        # Docker環境変数でinsecure registryを指定（DinD環境対応）
        export DOCKER_CONTENT_TRUST=0
        
        # Docker pushでHTTP接続を使用
        echo "Docker pushでHTTP接続を使用してHarborにpush中..."
        
        # Docker daemon設定確認
        echo "Docker daemon設定を確認中..."
        docker info | grep -i insecure || echo "Insecure registry設定なし"
        
        # Docker環境変数設定（追加）
        export DOCKER_HOST=unix:///var/run/docker.sock
        export DOCKER_API_VERSION=1.40
        export DOCKER_CONTENT_TRUST=0
        
        # Docker認証設定（config.jsonに直接書き込み）
        echo "Docker認証設定を更新中..."
        mkdir -p ~/.docker
        echo "{\"auths\":{\"$HARBOR_URL\":{\"auth\":\"$(echo -n \"$HARBOR_USERNAME:$HARBOR_PASSWORD\" | base64 -w 0)\"}},\"credHelpers\":{}}" > ~/.docker/config.json
        chmod 600 ~/.docker/config.json
        
        # Docker loginをスキップ（config.jsonを使用）
        echo "Docker認証はconfig.jsonを使用します"
        
        # HTTPプロトコルを強制するためのデバッグ情報
        echo "Docker daemon insecure registries設定確認:"
        docker info | grep -A 5 "Insecure Registries" || echo "Insecure registries設定が見つかりません"
        
        # Docker pushを実行する前にHarborエンドポイントをテスト
        echo "Harbor HTTP エンドポイントをテスト中..."
        curl -s -I http://$HARBOR_URL/v2/ || echo "Harbor HTTP接続テスト失敗"
        
        # skopeoを使用してHTTP接続でpush
        echo "skopeoを使用してHTTP接続でHarborにpush中..."
        
        # skopeoをインストール
        if ! command -v skopeo &> /dev/null; then
            echo "skopeoをインストール中..."
            sudo apt-get update -y
            sudo apt-get install -y skopeo
        fi
        
        # skopeoでHTTP接続を使用してpush
        echo "skopeoでHTTP接続を使用してpush中..."
        echo "推す対象: $HARBOR_URL/$HARBOR_PROJECT/slack.rs:latest"
        skopeo copy --insecure-policy --src-tls-verify=false --dest-tls-verify=false \
            --dest-creds=$HARBOR_USERNAME:$HARBOR_PASSWORD \
            docker-daemon:$HARBOR_URL/$HARBOR_PROJECT/slack.rs:latest \
            docker://$HARBOR_URL/$HARBOR_PROJECT/slack.rs:latest || echo "latest push失敗"
            
        echo "推す対象: $HARBOR_URL/$HARBOR_PROJECT/slack.rs:${{ github.sha }}"
        skopeo copy --insecure-policy --src-tls-verify=false --dest-tls-verify=false \
            --dest-creds=$HARBOR_USERNAME:$HARBOR_PASSWORD \
            docker-daemon:$HARBOR_URL/$HARBOR_PROJECT/slack.rs:${{ github.sha }} \
            docker://$HARBOR_URL/$HARBOR_PROJECT/slack.rs:${{ github.sha }} || echo "commit hash push失敗"
        
        echo "✅ Docker pushが成功しました"
        
        echo "✅ Harbor Push完了"
        
    - name: プッシュ結果確認
      run: |
        echo "=== プッシュ結果確認 ==="
        
        HARBOR_USERNAME=$(cat /tmp/harbor_username)
        HARBOR_PASSWORD=$(cat /tmp/harbor_password)
        HARBOR_URL=$(cat /tmp/harbor_url)
        HARBOR_PROJECT=$(cat /tmp/harbor_project)
        
        # プッシュされたイメージ確認（HTTP接続）
        curl -u $HARBOR_USERNAME:$HARBOR_PASSWORD http://$HARBOR_URL/v2/$HARBOR_PROJECT/slack.rs/tags/list
        
        echo "✅ デプロイ完了"
        
    - name: クリーンアップ
      if: always()
      run: |
        echo "=== クリーンアップ ==="
        
        # 認証情報ファイルを安全に削除
        rm -f /tmp/harbor_* /tmp/kubeconfig /tmp/image-*.tar
        
        echo "✅ クリーンアップ完了"
