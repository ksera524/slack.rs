name: Harborへのビルドとプッシュ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: slack-rs-runners 
    
    # 環境変数でk8s Secretから値を注入
    env:
      HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME || 'admin' }}
      HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD || 'adminadmin' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: 必要なツールのインストール
      run: |
        echo "=== Installing Required Tools ==="
        
        # kubectl インストール
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # jq が存在しない場合はインストール
        if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
        fi
        
        echo "✅ Tools installation completed"
        
    - name: Harbor認証情報取得
      run: |
        echo "=== Retrieving Harbor Credentials ==="
        
        # kubectl設定とアクセス権限確認
        echo "kubectl version:"
        kubectl version --client || echo "kubectl version check failed"
        
        # kubeconfig設定確認（GitHub Actions Runnerは既にクラスター内で動作）
        echo "Checking Kubernetes configuration:"
        if [ -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; then
            echo "✅ Running inside Kubernetes cluster"
            export KUBECONFIG=/var/run/secrets/kubernetes.io/serviceaccount/kubeconfig
            
            # In-cluster設定を作成
            kubectl config set-cluster default --server=https://kubernetes.default.svc --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            kubectl config set-credentials default --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
            kubectl config set-context default --cluster=default --user=default
            kubectl config use-context default
        else
            echo "⚠️  Not running inside Kubernetes cluster, using default config"
        fi
        
        echo "Current context:"
        kubectl config current-context || echo "No context set"
        
        echo "Testing kubectl access:"
        kubectl auth can-i get secrets -n arc-systems || echo "Cannot access secrets in arc-systems"
        kubectl auth can-i get secrets -n harbor || echo "Cannot access secrets in harbor"
        
        echo "Available namespaces:"
        kubectl get namespaces || echo "Cannot list namespaces"
        
        echo "Secrets in arc-systems namespace:"
        kubectl get secrets -n arc-systems || echo "Cannot access arc-systems namespace"
        
        # k8s Secret から Harbor認証情報を取得（詳細デバッグ付き）
        if kubectl get secret harbor-auth -n arc-systems >/dev/null 2>&1; then
            echo "✅ harbor-auth secret found"
            
            export HARBOR_USERNAME=$(kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_USERNAME}' | base64 -d)
            export HARBOR_PASSWORD=$(kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PASSWORD}' | base64 -d)
            echo "✅ Retrieved credentials from k8s Secret"
            echo "Retrieved Username: $HARBOR_USERNAME"
            echo "Retrieved Password: ${HARBOR_PASSWORD:0:3}..."
        else
            echo "⚠️  harbor-auth secret not found, using fallback credentials"
            export HARBOR_USERNAME="${HARBOR_USERNAME:-admin}"
            export HARBOR_PASSWORD="${HARBOR_PASSWORD:-adminadmin}"
            echo "Fallback Username: $HARBOR_USERNAME"
            echo "Fallback Password: ${HARBOR_PASSWORD:0:3}..."
        fi
        
        # 環境変数を後続ステップで利用可能にする
        echo "HARBOR_USERNAME=$HARBOR_USERNAME" >> $GITHUB_ENV
        echo "HARBOR_PASSWORD=$HARBOR_PASSWORD" >> $GITHUB_ENV
        
    - name: Harbor接続確認
      run: |
        echo "=== Harbor API Connection Test ==="
        echo "Harbor Username: $HARBOR_USERNAME"
        echo "Harbor Password: ${HARBOR_PASSWORD:0:3}..."
        
        # Harbor API接続テスト
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD https://192.168.122.100/v2/_catalog
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD https://192.168.122.100/api/v2.0/projects | jq '.[] | select(.name=="sandbox")'
        
    - name: Dockerイメージビルド
      run: |
        echo "=== Docker Image Build ==="
        
        # Docker認証設定
        mkdir -p ~/.docker
        echo '{"auths":{"192.168.122.100":{"auth":"'$(echo -n "$HARBOR_USERNAME:$HARBOR_PASSWORD" | base64 -w 0)'"}}}' > ~/.docker/config.json
        
        # Dockerイメージビルド
        docker build -t 192.168.122.100/sandbox/${{ github.event.repository.name }}:latest .
        docker build -t 192.168.122.100/sandbox/${{ github.event.repository.name }}:${{ github.sha }} .
        
    - name: Harborプッシュ（crane使用）
      run: |
        echo "=== Harbor Push with Crane ==="
        
        # DNS設定でharbor.local解決を有効化
        echo "192.168.122.100 harbor.local" | sudo tee -a /etc/hosts
        
        # Craneツールインストール
        curl -sL "https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz" | tar xz -C /tmp
        chmod +x /tmp/crane
        
        # Crane認証（insecure registry対応）
        export CRANE_INSECURE=true
        /tmp/crane auth login 192.168.122.100 -u $HARBOR_USERNAME -p $HARBOR_PASSWORD --insecure
        
        # latestタグプッシュ
        docker save 192.168.122.100/sandbox/${{ github.event.repository.name }}:latest -o /tmp/image-latest.tar
        /tmp/crane push /tmp/image-latest.tar 192.168.122.100/sandbox/${{ github.event.repository.name }}:latest --insecure
        
        # commitハッシュタグプッシュ
        docker save 192.168.122.100/sandbox/${{ github.event.repository.name }}:${{ github.sha }} -o /tmp/image-commit.tar
        /tmp/crane push /tmp/image-commit.tar 192.168.122.100/sandbox/${{ github.event.repository.name }}:${{ github.sha }} --insecure
        
        echo "✅ Harbor push completed successfully"
        
    - name: プッシュ結果確認
      run: |
        echo "=== Harbor Push Verification ==="
        
        # latestタグ確認
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD https://192.168.122.100/v2/sandbox/${{ github.event.repository.name }}/tags/list
        
        # リポジトリ一覧確認
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD "https://192.168.122.100/api/v2.0/projects/sandbox/repositories"
        
        echo "=== Deployment completed successfully ==="
