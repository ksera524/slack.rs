name: Harborへのビルドとプッシュ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: slack-rs-runners 
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Harbor接続確認
      run: |
        echo "=== Harbor API Connection Test ==="
        echo "HARBOR_USERNAME: $HARBOR_USERNAME"
        echo "HARBOR_PASSWORD: ${HARBOR_PASSWORD:0:5}..."
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD https://192.168.122.100/v2/_catalog
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD https://192.168.122.100/api/v2.0/projects | jq '.[] | select(.name=="sandbox")'
        
    - name: Dockerイメージビルド
      run: |
        echo "=== Docker Image Build ==="
        
        # Docker認証設定
        echo "Docker認証情報を設定中..."
        echo "HARBOR_USERNAME: $HARBOR_USERNAME"
        echo "HARBOR_PASSWORD: ${HARBOR_PASSWORD:0:5}..."
        
        # 環境変数の存在確認
        if [[ -z "$HARBOR_USERNAME" || -z "$HARBOR_PASSWORD" ]]; then
            echo "エラー: HARBOR_USERNAME または HARBOR_PASSWORD が設定されていません"
            exit 1
        fi
        
        mkdir -p ~/.docker
        # Base64エンコーディングを段階的に実行
        AUTH_STRING=$(echo -n "${HARBOR_USERNAME}:${HARBOR_PASSWORD}" | base64 -w 0)
        echo "認証文字列: ${AUTH_STRING:0:20}..."
        
        # JSON設定ファイルを作成
        cat > ~/.docker/config.json << EOF
{
  "auths": {
    "192.168.122.100": {
      "auth": "${AUTH_STRING}"
    }
  }
}
EOF
        
        # Dockerイメージビルド
        docker build -t 192.168.122.100/sandbox/${{ github.event.repository.name }}:latest .
        docker build -t 192.168.122.100/sandbox/${{ github.event.repository.name }}:${{ github.sha }} .
        
    - name: Harborプッシュ（crane使用）
      run: |
        echo "=== Harbor Push with Crane ==="
        
        # DNS設定でharbor.local解決を有効化
        echo "192.168.122.100 harbor.local" | sudo tee -a /etc/hosts
        
        # Craneツールインストール
        curl -sL "https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz" | tar xz -C /tmp
        chmod +x /tmp/crane
        
        # Docker認証設定（非インタラクティブ対応）
        echo "Docker認証情報を設定中..."
        echo "HARBOR_USERNAME: $HARBOR_USERNAME"
        echo "HARBOR_PASSWORD: ${HARBOR_PASSWORD:0:5}..."
        
        # 環境変数の存在確認
        if [[ -z "$HARBOR_USERNAME" || -z "$HARBOR_PASSWORD" ]]; then
            echo "エラー: HARBOR_USERNAME または HARBOR_PASSWORD が設定されていません"
            exit 1
        fi
        
        mkdir -p ~/.docker
        # Base64エンコーディングを段階的に実行
        AUTH_STRING=$(echo -n "${HARBOR_USERNAME}:${HARBOR_PASSWORD}" | base64 -w 0)
        echo "認証文字列: ${AUTH_STRING:0:20}..."
        
        # JSON設定ファイルを作成
        cat > ~/.docker/config.json << EOF
{
  "auths": {
    "192.168.122.100": {
      "auth": "${AUTH_STRING}"
    }
  }
}
EOF
        
        # 設定ファイルの確認
        echo "Docker config.json内容:"
        cat ~/.docker/config.json
        
        # Crane認証（insecure registry対応）
        export CRANE_INSECURE=true
        /tmp/crane auth login 192.168.122.100 -u $HARBOR_USERNAME -p $HARBOR_PASSWORD --insecure
        
        # latestタグプッシュ
        docker save 192.168.122.100/sandbox/${{ github.event.repository.name }}:latest -o /tmp/image-latest.tar
        /tmp/crane push /tmp/image-latest.tar 192.168.122.100/sandbox/${{ github.event.repository.name }}:latest --insecure
        
        # commitハッシュタグプッシュ
        docker save 192.168.122.100/sandbox/${{ github.event.repository.name }}:${{ github.sha }} -o /tmp/image-commit.tar
        /tmp/crane push /tmp/image-commit.tar 192.168.122.100/sandbox/${{ github.event.repository.name }}:${{ github.sha }} --insecure
        
        echo "✅ Harbor push completed successfully"
        
    - name: プッシュ結果確認
      run: |
        echo "=== Harbor Push Verification ==="
        
        # latestタグ確認
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD https://192.168.122.100/v2/sandbox/${{ github.event.repository.name }}/tags/list
        
        # リポジトリ一覧確認
        curl -k -u $HARBOR_USERNAME:$HARBOR_PASSWORD "https://192.168.122.100/api/v2.0/projects/sandbox/repositories"
        
        echo "=== Deployment completed successfully ==="
