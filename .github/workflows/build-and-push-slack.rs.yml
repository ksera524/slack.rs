Skip to content
Navigation Menu
ksera524
slack.rs

Type / to search
Code
Issues
Pull requests
Actions
Projects
Wiki
Security
Insights
Settings
slack.rs/.github/workflows
/
build-and-push-slack.rs.yml
in
main

Edit

Preview
Indent mode

Spaces
Indent size

2
Line wrap mode

No wrap
Editing build-and-push-slack.rs.yml file contents
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
# GitHub Actions workflow for slack.rs
# Auto-generated by add-runner.sh (公式ARC対応版)

name: Build and Push to Harbor - slack.rs

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: slack-rs-runners  # Kubernetes Runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup kubectl and Harbor credentials
      run: |
        echo "=== Setup kubectl and Harbor credentials ==="
        
        # Install kubectl
        echo "Installing kubectl..."
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Configure kubectl for in-cluster access
        echo "Configuring kubectl..."
        export KUBECONFIG=/tmp/kubeconfig
        kubectl config set-cluster default \
            --server=https://kubernetes.default.svc \
            --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            --kubeconfig=$KUBECONFIG
        kubectl config set-credentials default \
            --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) \
            --kubeconfig=$KUBECONFIG
        kubectl config set-context default \
            --cluster=default --user=default \
            --kubeconfig=$KUBECONFIG
        kubectl config use-context default --kubeconfig=$KUBECONFIG
        
        # Get Harbor credentials
        echo "Getting Harbor credentials..."
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_USERNAME}' | base64 -d > /tmp/harbor_username
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PASSWORD}' | base64 -d > /tmp/harbor_password
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_URL}' | base64 -d > /tmp/harbor_url
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PROJECT}' | base64 -d > /tmp/harbor_project
        
        chmod 600 /tmp/harbor_*
        echo "✅ Harbor credentials retrieved successfully"
        
    - name: Build and push images using skopeo
      run: |
        echo "=== Build and push images using skopeo ==="
        
        HARBOR_USERNAME=$(cat /tmp/harbor_username)
        HARBOR_PASSWORD=$(cat /tmp/harbor_password)
        HARBOR_URL=$(cat /tmp/harbor_url)
        HARBOR_PROJECT=$(cat /tmp/harbor_project)
        
        # Install skopeo
        echo "Installing skopeo..."
        sudo apt-get update && sudo apt-get install -y skopeo
        
        # Build Docker images
        echo "Building Docker images..."
        docker build -t slack.rs:latest .
        docker build -t slack.rs:${{ github.sha }} .
        
        # Push using skopeo - エラー修正: ポート番号を明示的に指定
        echo "Pushing to Harbor using skopeo..."
        docker save slack.rs:latest > /tmp/slack.rs-latest.tar
        docker save slack.rs:${{ github.sha }} > /tmp/slack.rs-sha.tar
        
        # /etc/hostsにharbor.localを追加
        echo "192.168.122.100 harbor.local" | sudo tee -a /etc/hosts
        
        # Harborのポートを明示的に指定
        skopeo copy --insecure-policy --dest-tls-verify=false \
          --dest-creds="$HARBOR_USERNAME:$HARBOR_PASSWORD" \
          docker-archive:/tmp/slack.rs-latest.tar \
          docker://harbor.local:80/$HARBOR_PROJECT/slack.rs:latest
        
        skopeo copy --insecure-policy --dest-tls-verify=false \
          --dest-creds="$HARBOR_USERNAME:$HARBOR_PASSWORD" \
          docker-archive:/tmp/slack.rs-sha.tar \
          docker://harbor.local:80/$HARBOR_PROJECT/slack.rs:${{ github.sha }}
        
        echo "✅ Images pushed successfully to Harbor"
        
    - name: Cleanup
      if: always()
      run: |
        echo "=== Cleanup ==="
        rm -f /tmp/harbor_* /tmp/kubeconfig /tmp/slack.rs-*.tar
        echo "✅ Cleanup completed"

Use Control + Shift + m to toggle the tab key moving focus. Alternatively, use esc then tab to move to the next interactive element on the page.
Use Control + Space to trigger autocomplete in most situations.
Help Panel navigation
Marketplace
Documentation
Search Marketplace for Actions
Featured Actions

Upload a build artifact that can be used by subsequent workflow steps

 3.8k

Set up a specific version of the Java JDK and add the command-line tools to the PATH

 1.8k

Download a build artifact that was previously uploaded in the workflow by the upload-artifact action

 1.7k

Setup a Go environment and add it to the PATH

 1.6k

Used to build and publish .NET source. Set up a specific version of the .NET and authentication to private NuGet repository

 1.1k
Featured categories
Browse all actions on the GitHub Marketplace
 
