# GitHub Actions workflow for slack.rs
# Auto-generated by add-runner.sh (ÂÖ¨ÂºèARCÂØæÂøúÁâà) - Auto SemverÁâà

name: Build and Push to Harbor - slack.rs

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    
permissions:
  contents: write  # „Çø„Ç∞„ÅÆ‰ΩúÊàê„Å®push„Å´ÂøÖË¶Å
  pull-requests: read

jobs:
  build-and-push:
    runs-on: slack-rs-runners  # Kubernetes Runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÂÖ®Â±•Ê≠¥„ÇíÂèñÂæó„Åó„Å¶„Çø„Ç∞ÊÉÖÂ†±„ÇíÂèñÂæó
      
    - name: Auto increment version
      id: version
      run: |
        # ÊúÄÊñ∞„ÅÆ„Çø„Ç∞„ÇíÂèñÂæóÔºàÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ0.0.0„Åã„ÇâÈñãÂßãÔºâ
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST_TAG"
        
        # v prefix „ÇíÂâäÈô§
        LATEST_VERSION=${LATEST_TAG#v}
        
        # „Éê„Éº„Ç∏„Éß„É≥„ÇíÂàÜËß£
        IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
        
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # PRÊôÇ„ÅØ„Éì„É´„Éâ„ÅÆ„Åø„ÄÅpush„Åó„Å™„ÅÑ
          VERSION="pr-${{ github.event.pull_request.number }}-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should_push=false" >> $GITHUB_OUTPUT
          echo "should_tag=false" >> $GITHUB_OUTPUT
          echo "üîç PR Build: $VERSION (build only, no push)"
        else
          # main„Å∏„ÅÆpushÊôÇ„ÅØËá™ÂãïÁöÑ„Å´„Éë„ÉÉ„ÉÅ„Éê„Éº„Ç∏„Éß„É≥„Çí„Ç§„É≥„ÇØ„É™„É°„É≥„Éà
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "should_push=true" >> $GITHUB_OUTPUT
          echo "should_tag=true" >> $GITHUB_OUTPUT
          echo "üì¶ New Version: $NEW_VERSION (auto-incremented from $LATEST_VERSION)"
        fi
      
    - name: Setup kubectl and Harbor credentials
      run: |
        echo "=== Setup kubectl and Harbor credentials ==="
        
        # Install kubectl
        echo "Installing kubectl..."
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Configure kubectl for in-cluster access
        echo "Configuring kubectl..."
        export KUBECONFIG=/tmp/kubeconfig
        kubectl config set-cluster default \
            --server=https://kubernetes.default.svc \
            --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            --kubeconfig=$KUBECONFIG
        kubectl config set-credentials default \
            --token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) \
            --kubeconfig=$KUBECONFIG
        kubectl config set-context default \
            --cluster=default --user=default \
            --kubeconfig=$KUBECONFIG
        kubectl config use-context default --kubeconfig=$KUBECONFIG
        
        # Get Harbor credentials
        echo "Getting Harbor credentials..."
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_USERNAME}' | base64 -d > /tmp/harbor_username
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PASSWORD}' | base64 -d > /tmp/harbor_password
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_URL}' | base64 -d > /tmp/harbor_url
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PROJECT}' | base64 -d > /tmp/harbor_project
        kubectl get secret ca-key-pair -n cert-manager -o jsonpath='{.data.ca\.crt}' | base64 -d > /tmp/harbor_ca.crt
        
        chmod 600 /tmp/harbor_*
        echo "‚úÖ Harbor credentials retrieved successfully"
        
    - name: Build and push images using Docker
      run: |
        echo "=== Build and push images using Docker ==="
        
        HARBOR_USERNAME=$(cat /tmp/harbor_username)
        HARBOR_PASSWORD=$(cat /tmp/harbor_password)
        HARBOR_URL="harbor.internal.qroksera.com"
        HARBOR_PROJECT=$(cat /tmp/harbor_project)
        VERSION="${{ steps.version.outputs.version }}"
        SHOULD_PUSH="${{ steps.version.outputs.should_push }}"

        # ÂÜÖÈÉ®CA„Çí‰ø°È†º„Çπ„Éà„Ç¢„Å´ËøΩÂä†
        echo "Installing internal CA..."
        sudo cp /tmp/harbor_ca.crt /usr/local/share/ca-certificates/harbor-internal-ca.crt
        sudo update-ca-certificates

        # DockerÁî®„ÅÆCAË®≠ÂÆö
        echo "Configuring Docker CA..."
        sudo mkdir -p /etc/docker/certs.d/harbor.internal.qroksera.com
        sudo cp /tmp/harbor_ca.crt /etc/docker/certs.d/harbor.internal.qroksera.com/ca.crt
        
        # Build Docker images
        echo "Building Docker image with version: $VERSION"
        docker build -t $HARBOR_URL/$HARBOR_PROJECT/slack.rs:$VERSION .
        docker build -t $HARBOR_URL/$HARBOR_PROJECT/slack.rs:${{ github.sha }} .
        docker tag $HARBOR_URL/$HARBOR_PROJECT/slack.rs:$VERSION $HARBOR_URL/$HARBOR_PROJECT/slack.rs:latest

        # push„Åô„Çã„Åã„Å©„ÅÜ„Åã„ÅÆÂà§ÂÆöÔºàPRÊôÇ„ÅØpush„Åó„Å™„ÅÑÔºâ
        if [ "$SHOULD_PUSH" == "false" ]; then
          echo "‚è≠Ô∏è  Skipping push (PR build only)"
          exit 0
        fi

        # /etc/hosts„Å´harbor.internal.qroksera.com„ÇíËøΩÂä†
        echo "192.168.122.100 harbor.internal.qroksera.com" | sudo tee -a /etc/hosts

        # Harbor„Å´„É≠„Ç∞„Ç§„É≥
        echo "Logging in to Harbor..."
        docker login $HARBOR_URL -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"

        # Harbor„Å∏push
        echo "Pushing to Harbor..."
        docker push $HARBOR_URL/$HARBOR_PROJECT/slack.rs:$VERSION
        docker push $HARBOR_URL/$HARBOR_PROJECT/slack.rs:${{ github.sha }}
        docker push $HARBOR_URL/$HARBOR_PROJECT/slack.rs:latest
        
        echo "‚úÖ Images pushed successfully to Harbor"
        echo "üì¶ Pushed tags: $VERSION, ${{ github.sha }}, latest"

    - name: Create and push git tag
      if: steps.version.outputs.should_tag == 'true'
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Git„ÅÆË®≠ÂÆö
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # „Çø„Ç∞„Çí‰ΩúÊàê
        git tag -a "v$VERSION" -m "Auto-generated version v$VERSION"
        
        # „Çø„Ç∞„Çípush
        git push origin "v$VERSION"
        
        echo "‚úÖ Created and pushed tag: v$VERSION"
        
    - name: Cleanup
      if: always()
      run: |
        echo "=== Cleanup ==="
        rm -f /tmp/harbor_* /tmp/kubeconfig /tmp/slack.rs-*.tar
        echo "‚úÖ Cleanup completed"
